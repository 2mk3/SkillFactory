# **Оформление оплаты заказа с использованием личного кабинета**
#### _Цель: Оформить оплату заказа одни из способов оплаты:_ 
**_1. Оплата банковской картой на сайте_**
>_1.1. Системные требования:_
* Система должна формировать аутентификационный запрос в банк-эмитент пользователя после полученных от пользователя в заказе платежных реквизитов.

**_2. Оплата банковской картой или наличными курьеру_**
>_2.1. Системные требования:_ 
- Система должна актуализировать информацию в заказе пользователя после полученной от пользователя информации о способе оплаты, в заказе.

**_3. Частичная оплата бонусами_**
>_3.1. Системные требования:_
- Система должна осуществить проверку накопленных пользователем бонусов после полученного от пользователя в заказе количества бонусов для списания, затем списать накопленные пользователем бонусы и сформировать аутентификационный запрос в банк-эмитент пользователя.

#### _Сценарий оплаты “Банковской картой на сайте”:_
1. Пользователь выбирает способ оплаты: “Оплата банковской картой на сайте”: на экране “Оформления заказа” и нажимает кнопку “Продолжить”
2. Система переадресовывает пользователя на авторизационную страницу Внешней системы
3. Пользователь вводит данные банковской карты
4. Внешняя система формирует аутентификационный запрос и направляет пользователя в систему аутентификации Банка
5. В результате положительного ответа от аутентификационного запроса Банк формирует сообщение Внешней системе о совершении операции
6. Внешняя система информирует Систему и Пользователя о совершении операции
7. Система выводит сообщение об успешной оплате на экране “Оформления заказа”
8. Система записывает статус “В обработке” в заказ Пользователя
9. Система начисляет Пользователю в личном кабинете количество бонусов по формуле: `количество накопленных бонусов Пользователя = количество накопленных бонусов Пользователя + сумма заказа * 0,05`

#### _Сценарий выбора пользователем способа оплаты: “Банковской картой или наличными курьеру”:_
1. Пользователь выбирает способ оплаты: “Банковской картой или наличными курьеру”: на экране “Оформления заказа” и нажимает кнопку “Продолжить”
2. Система выводит сообщение об успешно сформированном заказе на экране “Оформления заказа”
3. Система записывает статус “В обработке” в заказ Пользователя

#### _Сценарий выбора пользователем способа оплаты: “Частичная оплата бонусами”:_
1. Пользователь выбирает способ оплаты: “Частичная оплаты бонусами”: на экране “Оформления заказа” и нажимает кнопку “Продолжить”
2. Система выводит поле ввода желаемого количества бонусов Пользователя для списания и оплаты заказа, поверх экрана “Оформления заказа”
3. Пользователь вводит желаемое количество бонусов Пользователя для списания в поле ввода
4. Система высчитывает возможность оплаты бонусами Пользователя по формуле: `желаемое количество бонусов Пользователя для списания >= сумма заказа * 0,5`
5. Система получает положительный или нулевой результат о возможности оплаты бонусами Пользователя
6. Система вычисляет новую сумму заказа по формуле: `новая сумма заказа = желаемое количество бонусов Пользователя для списания - сумма заказа * 0,5`
7. Система вычитает новую сумму заказа из суммы заказа и накопленных Пользователем бонусов
8. Система переадресовывает пользователя на авторизационную страницу Внешней системы
9. Пользователь вводит данные банковской карты
10. Внешняя система формирует аутентификационный запрос и направляет пользователя в систему аутентификации Банка
11. В результате положительного ответа от аутентификационного запроса Банк формирует сообщение Внешней системе о совершении операции
12. Внешняя система информирует Систему и Пользователя о совершении операции
13. Система выводит сообщение об успешной оплате на экране   “Оформления заказа”
14. Система записывает статус “В обработке” в заказ Пользователя

#### _Альтернативный сценарий выбора пользователем способа оплаты: “Частичная оплата бонусами”:_
4. Система получает отрицательный результат о возможности частичной оплаты бонусами Пользователя
5. Система выводит сообщение Пользователю: “На счете недостаточно бонусов, проверьте баланс (Сумма оплаты бонусами недолжна превышать 50% суммы Заказа)”
6. Пользователь нажимает кнопку “ОК”
7. Система направляет пользователя на экран “Оформления заказа”

#### _Исключение сценария оплаты “Банковской картой на сайте”:_
1. Система получает информацию от Внешней системы об отказе в оплате заказа и причинах
2. Система выводит сообщение Пользователю: “Отказ Банка. Пожалуйста выберите другой способ оплаты или отмените заказ”
3. Система направляет пользователя на экран “Оформления заказа”